#!/bin/bash
# GA Setup - Configure GA parameters before running optimization
# Usage: ./ga/scripts/ga_setup.sh [options]
#
# Options:
#   --population=N       Population size (default: 10)
#   --generations=N      Number of generations (default: 10)
#   --offspring=N        Offspring per generation (default: 7)
#   --crossover-rate=N   Probability of crossover vs mutation (default: 0.8)
#   --mutation-rate=N    Mutation probability (default: 0.2)
#   --reset              Clear existing state and start fresh
#
# Example:
#   ./ga/scripts/ga_setup.sh --population=10 --generations=5 --reset

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
GA_DIR="$(dirname "$SCRIPT_DIR")"
CONFIG_FILE="$SCRIPT_DIR/ga_config.sh"

# Defaults
POPULATION=10
GENERATIONS=10
OFFSPRING=7
CROSSOVER_RATE=0.8
MUTATION_RATE=0.2
RESET=false

# Parse arguments
for arg in "$@"; do
    case $arg in
        --population=*)
            POPULATION="${arg#*=}"
            ;;
        --generations=*)
            GENERATIONS="${arg#*=}"
            ;;
        --offspring=*)
            OFFSPRING="${arg#*=}"
            ;;
        --crossover-rate=*)
            CROSSOVER_RATE="${arg#*=}"
            ;;
        --mutation-rate=*)
            MUTATION_RATE="${arg#*=}"
            ;;
        --reset)
            RESET=true
            ;;
        --help|-h)
            head -15 "$0" | tail -n +2 | sed 's/^# //' | sed 's/^#//'
            exit 0
            ;;
        *)
            echo "Unknown option: $arg"
            echo "Use --help for usage"
            exit 1
            ;;
    esac
done

# Write config file
cat > "$CONFIG_FILE" << EOF
#!/bin/bash
# GA Configuration - generated by ga_setup.sh
# Modify via: ./ga/scripts/ga_setup.sh --population=X ...

# Population settings
POPULATION=$POPULATION
GENERATIONS=$GENERATIONS
OFFSPRING=$OFFSPRING

# Genetic operator rates
CROSSOVER_RATE=$CROSSOVER_RATE
MUTATION_RATE=$MUTATION_RATE
EOF

echo "[CONFIG] Written to $CONFIG_FILE:"
echo "  POPULATION=$POPULATION"
echo "  GENERATIONS=$GENERATIONS"
echo "  OFFSPRING=$OFFSPRING"
echo "  CROSSOVER_RATE=$CROSSOVER_RATE"
echo "  MUTATION_RATE=$MUTATION_RATE"

# Reset if requested
if [ "$RESET" = true ]; then
    echo "[RESET] Clearing existing state..."
    rm -rf "$GA_DIR/candidates/CAND_"* \
           "$GA_DIR/candidates/state.txt" \
           "$GA_DIR/candidates/scores.txt" \
           "$GA_DIR/candidates/eval_cache.txt" \
           "$GA_DIR/optimization_progress.txt" \
           "$GA_DIR/best" 2>/dev/null || true
    echo "[RESET] Ready for fresh start"
fi
